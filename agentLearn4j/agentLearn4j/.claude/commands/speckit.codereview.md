---
description: 基于阿里巴巴Java开发规范对代码进行全面审查和质量评估
---

## User Input

```text
$ARGUMENTS
```

You **MUST** consider the user input before proceeding (if not empty).

## 命令目标

基于《阿里巴巴Java开发手册》对Java代码进行全面的规范性检查，识别代码质量问题、安全隐患和最佳实践偏离，输出结构化的审查报告。

## 适用场景

- 功能开发完成后的代码审查
- 重构前的代码质量评估
- 团队代码规范合规性检查
- Pull Request提交前的自检

## 执行约束

**严格只读模式**: 不修改任何文件。仅输出分析报告。若需要修复，需用户明确批准后再执行。

**规范权威性**: 阿里巴巴Java开发手册的规范分为强制、推荐和参考三个级别：
- **强制**: 必须遵守的编程规约，违反会严重影响代码质量
- **推荐**: 建议遵守的编程规约，提升代码可读性和可维护性
- **参考**: 可选的编程建议，在特定场景下采用

## 执行步骤

### 1. 确定审查范围

根据用户输入确定审查范围：

**用户未指定或指定 "all" / "全部"**:
```bash
find . -name "*.java" -path "*/src/main/*" -not -path "*/target/*" -not -path "*/.git/*"
```

**用户指定具体文件或目录**:
- 单个文件: 审查指定的Java文件
- 目录: 审查目录下所有Java文件（递归）
- 模式匹配: 支持通配符，如 `*Controller.java`, `service/**/*.java`

**智能过滤**:
- 排除 target/, build/, .git/, node_modules/ 等构建产物目录
- 排除测试代码（除非用户明确指定 `--include-tests`）
- 优先审查 src/main/java/ 下的业务代码

### 2. 加载阿里巴巴Java开发规范知识库

基于《阿里巴巴Java开发手册》（嵩山版），构建以下检查维度：

#### A. 编程规约

**命名规范 [强制/推荐]**:
- 类名使用UpperCamelCase
- 方法名、参数名、成员变量、局部变量使用lowerCamelCase
- 常量命名全部大写，单词间用下划线隔开 UPPER_CASE
- 包名统一使用小写，点分隔符之间有且仅有一个自然语义的英语单词
- 抽象类命名使用Abstract或Base开头
- 异常类命名使用Exception结尾
- 测试类命名以要测试的类名开始，以Test结尾
- POJO类中布尔类型变量不要加is前缀
- 避免使用拼音与英文混合的方式，更不允许直接使用中文命名

**代码格式 [强制]**:
- 大括号的使用约定：左大括号前不换行，后换行；右大括号前换行
- if/for/while/switch/do等保留字与括号之间都必须加空格
- 任何二目、三目运算符的左右两边都需要加一个空格
- 缩进采用4个空格，禁止使用tab字符
- 单行字符数限制不超过120个
- 方法参数在定义和传入时，多个参数逗号后边必须加空格

**OOP规约 [强制/推荐]**:
- 避免通过一个类的对象引用访问此类的静态变量或静态方法
- 所有覆写方法必须加@Override注解
- 相同参数类型、相同业务含义，才可使用可变参数
- 外部正在调用或二方库依赖的接口，不允许修改方法签名
- 不能使用过时的类或方法
- Object的equals方法容易抛空指针异常，应使用常量或确定有值的对象来调用equals
- 所有整型包装类对象值的比较，全部使用equals方法比较
- 浮点数之间的等值判断，基本数据类型不能用==来比较，包装数据类型不能用equals来判断
- BigDecimal的等值比较应使用compareTo()方法
- 定义DO/DTO/VO等POJO类时，不要设定任何属性默认值
- POJO类必须写toString方法

**集合处理 [强制/推荐]**:
- 关于hashCode和equals的处理，遵循规约：只要覆写equals，就必须覆写hashCode
- ArrayList的subList结果不可强转成ArrayList
- 使用集合转数组的方法，必须使用集合的toArray(T[] array)
- 使用工具类Arrays.asList()把数组转换成集合时，不能使用其修改集合相关的方法
- 泛型通配符<? extends T>来接收返回的数据，此写法的泛型集合不能使用add方法
- 不要在foreach循环里进行元素的remove/add操作
- 在JDK7版本及以上，Comparator实现类要满足如下三个条件，不然Arrays.sort，Collections.sort会抛IllegalArgumentException异常

**并发处理 [强制/推荐]**:
- 获取单例对象需要保证线程安全，其中的方法也要保证线程安全
- 创建线程或线程池时请指定有意义的线程名称，方便出错时回溯
- 线程资源必须通过线程池提供，不允许在应用中自行显式创建线程
- 线程池不允许使用Executors去创建，而是通过ThreadPoolExecutor的方式
- SimpleDateFormat是线程不安全的类，需要独立使用
- 必须回收自定义的ThreadLocal变量，尤其在线程池场景下
- 高并发时，同步调用应该考虑锁的性能损耗

**控制语句 [强制/推荐]**:
- 在一个switch块内，每个case要么通过break/return等来终止，要么注释说明程序将继续执行到哪一个case
- 在if/else/for/while/do语句中必须使用大括号
- 三目运算符condition? 表达式1 : 表达式2中，高度注意表达式1和2在类型对齐时，可能抛出因自动拆箱导致的NPE异常
- 在高并发场景中，避免使用"等于"判断作为中断或退出的条件
- 表达异常的分支时，少用if-else方式
- 除常用方法（如getXxx/isXxx）等外，不要在条件判断中执行其它复杂的语句

**注释规约 [强制/推荐]**:
- 类、类属性、类方法的注释必须使用Javadoc规范
- 所有的抽象方法必须用Javadoc注释
- 所有的类都必须添加创建者和创建日期
- 方法内部单行注释，在被注释语句上方另起一行，使用//注释
- 所有的枚举类型字段必须要有注释
- 代码修改的同时，注释也要进行相应的修改

#### B. 异常处理规约

**异常处理 [强制/推荐]**:
- Java类库中定义的可以通过预检查方式规避的RuntimeException异常不应该通过catch的方式来处理
- 异常不要用来做流程控制，条件控制
- catch时请分清稳定代码和非稳定代码，对于非稳定代码的catch尽可能区分异常类型
- 捕获异常是为了处理它，不要捕获了却什么都不处理而抛弃之
- 事务场景中，抛出异常被catch后，如果需要回滚，一定要注意手动回滚事务
- finally块必须对资源对象、流对象进行关闭，有异常也要做try-catch
- 不要在finally块中使用return
- 方法的返回值可以为null，不强制返回空集合或空对象，但必须添加注释说明什么情况下会返回null值
- 防止NPE，是程序员的基本修养，注意NPE产生的场景

#### C. MySQL数据库规约

**建表规约 [强制/推荐]**:
- 表达是与否概念的字段，必须使用is_xxx的方式命名，数据类型是unsigned tinyint
- 表名、字段名必须使用小写字母或数字，禁止出现数字开头
- 表名不使用复数名词
- 禁用保留字
- 主键索引名为pk_字段名；唯一索引名为uk_字段名；普通索引名为idx_字段名
- 小数类型为decimal，禁止使用float和double
- 如果存储的字符串长度几乎相等，使用char定长字符串类型
- varchar是可变长字符串，不预先分配存储空间，长度不要超过5000

**索引规约 [强制/推荐]**:
- 业务上具有唯一特性的字段，即使是多个字段的组合，也必须建成唯一索引
- 超过三个表禁止join
- 在varchar字段上建立索引时，必须指定索引长度
- 页面搜索严禁左模糊或全模糊，如果需要请走搜索引擎来解决
- 利用覆盖索引来进行查询操作，避免回表

**SQL语句规约 [强制/推荐]**:
- 不要使用count(列名)或count(常量)来替代count(*)
- count(distinct col) 计算该列除NULL之外的不重复行数
- 当某一列的值全是NULL时，count(col)的返回结果为0
- 不得使用外键与级联，一切外键概念必须在应用层解决
- 禁止使用存储过程
- 数据订正时，删除和修改记录时，要先select，避免出现误删除

#### D. 工程结构规约

**应用分层 [推荐]**:
- 开放接口层
- Web层
- Service层
- Manager层
- DAO层
- 外部接口或第三方平台

**二方库依赖 [强制]**:
- 定义GAV遵从规则
- 二方库的新增或升级，保持除功能点之外的其它jar包仲裁结果不变
- 二方库里可以定义枚举类型，参数可以使用枚举类型，但接口返回值不允许使用枚举类型或包含枚举类型的POJO对象

**服务器规约 [推荐]**:
- 高并发服务器建议调小TCP协议的time_wait超时时间
- 调大服务器所支持的最大文件句柄数
- 给JVM环境参数设置-XX:+HeapDumpOnOutOfMemoryError参数

#### E. 安全规约

**安全规约 [强制/推荐]**:
- 隶属于用户个人的页面或功能必须进行权限控制校验
- 用户敏感数据禁止直接展示，必须对展示数据进行脱敏
- 用户输入的SQL参数严格使用参数绑定或METADATA字段值限定，防止SQL注入
- 用户请求传入的任何参数必须做有效性验证
- 禁止向HTML页面输出未经安全过滤或未正确转义的用户数据
- 表单、AJAX提交必须执行CSRF安全验证
- URL外部重定向传入的目标地址必须执行白名单过滤
- 在使用平台资源，譬如短信、邮件、电话、下单、支付，必须实现正确的防重放的机制

### 3. 逐文件检查分析

对范围内的每个Java文件执行：

**阶段1: 静态结构分析**
- 包声明、导入语句检查
- 类、接口、枚举定义分析
- 成员变量、方法签名提取
- 注解使用情况统计

**阶段2: 规范符合性检查**
- 命名规范验证（类名、方法名、变量名、常量名）
- 代码格式检查（缩进、空格、换行）
- OOP原则应用检查
- 集合使用规范验证
- 并发编程规范检查
- 异常处理合规性验证
- 数据库访问规范检查（如果涉及）
- 注释完整性检查

**阶段3: 代码质量评估**
- 圈复杂度计算（方法不应超过15）
- 方法长度检查（不应超过80行）
- 类长度检查（不应超过500行）
- 参数个数检查（不应超过5个）
- 嵌套深度检查（不应超过4层）
- 重复代码检测
- 魔法值检测

**阶段4: 安全漏洞扫描**
- SQL注入风险点
- XSS攻击风险点
- 敏感信息泄露风险
- 不安全的加密使用
- 权限校验缺失

### 4. 严重程度分级

根据阿里巴巴规范级别和影响程度，将发现的问题分为：

- **BLOCKER（阻断）**: 违反强制规约，可能导致严重bug或安全问题
  - 例：SQL注入、空指针、线程安全问题、资源泄露

- **CRITICAL（严重）**: 违反强制规约，影响代码质量和可维护性
  - 例：命名不规范、equals未覆写hashCode、异常处理不当

- **MAJOR（重要）**: 违反推荐规约，应当修复
  - 例：缺少注释、方法过长、参数过多

- **MINOR（次要）**: 违反推荐规约，建议修复
  - 例：代码格式问题、变量命名不够清晰

- **INFO（提示）**: 参考级建议，可选优化
  - 例：可以使用更简洁的写法、可以提取常量

### 5. 生成代码审查报告

输出格式化的Markdown报告：

```markdown
# 代码审查报告

## 审查概览

| 指标 | 值 |
|------|-----|
| 审查文件数 | 15 |
| 代码总行数 | 3,420 |
| 发现问题数 | 23 |
| BLOCKER | 2 |
| CRITICAL | 5 |
| MAJOR | 8 |
| MINOR | 6 |
| INFO | 2 |
| 整体评分 | 72/100 |

## 问题详情

| ID | 严重程度 | 规范类别 | 位置 | 问题描述 | 建议修复 |
|----|----------|----------|------|----------|----------|
| CR001 | BLOCKER | 并发处理 | UserService.java:45 | SimpleDateFormat在多线程环境下使用，存在线程安全问题 | 使用ThreadLocal<SimpleDateFormat>或DateTimeFormatter |
| CR002 | CRITICAL | 集合处理 | OrderController.java:89 | 在foreach循环中执行remove操作 | 使用Iterator.remove()或使用removeIf() |
| CR003 | MAJOR | 命名规范 | ProductDTO.java:12 | 布尔类型字段isActive不符合规范 | 改为active |
| ... | ... | ... | ... | ... | ... |

## 各文件详细分析

### UserService.java
- **文件行数**: 234
- **方法数**: 12
- **圈复杂度**: 平均 5.2, 最高 12 (getUserInfo方法)
- **问题数**: 5 (BLOCKER: 1, CRITICAL: 1, MAJOR: 2, MINOR: 1)

**问题列表**:
1. [BLOCKER] 第45行: SimpleDateFormat线程不安全
2. [CRITICAL] 第78行: 空指针风险，未对user对象判空
3. [MAJOR] 第102行: 方法getUserInfo圈复杂度12，超过建议值10
4. [MAJOR] 第156行: 缺少方法注释
5. [MINOR] 第189行: 变量命名data不够语义化

### OrderController.java
...

## 规范符合度统计

| 规范类别 | 检查项数 | 符合数 | 违反数 | 符合率 |
|----------|----------|--------|--------|--------|
| 命名规范 | 45 | 42 | 3 | 93% |
| 代码格式 | 67 | 65 | 2 | 97% |
| OOP规约 | 23 | 20 | 3 | 87% |
| 集合处理 | 15 | 13 | 2 | 87% |
| 并发处理 | 8 | 6 | 2 | 75% |
| 控制语句 | 34 | 32 | 2 | 94% |
| 注释规约 | 28 | 22 | 6 | 79% |
| 异常处理 | 19 | 17 | 2 | 89% |
| 安全规约 | 12 | 11 | 1 | 92% |

## 代码质量指标

- **平均方法长度**: 28行（建议<50行）✓
- **平均圈复杂度**: 5.8（建议<10）✓
- **最大嵌套深度**: 5层（建议<4层）✗
- **重复代码块**: 3处
- **魔法值数量**: 12个

## 优先修复建议

根据严重程度和影响范围，建议优先修复以下问题：

1. **UserService.java:45** - BLOCKER级别线程安全问题，影响生产环境稳定性
2. **OrderService.java:123** - BLOCKER级别SQL注入风险，存在安全隐患
3. **ProductDTO.java** - CRITICAL级别，多处equals/hashCode不配对
4. **PaymentService.java:67** - CRITICAL级别，异常被吞掉未处理
5. **UserController.java:234** - MAJOR级别，缺少权限校验

## 最佳实践建议

1. **异常处理**: 建议统一使用全局异常处理器，避免在每个方法中重复catch
2. **日志规范**: 建议引入统一的日志规范，使用SLF4J + Logback
3. **常量管理**: 建议将魔法值提取为常量类或枚举
4. **代码复用**: 发现3处重复代码，建议提取为公共方法
5. **单元测试**: 建议为Service层方法补充单元测试

## 下一步行动

- [ ] 修复2个BLOCKER级别问题（必须）
- [ ] 修复5个CRITICAL级别问题（强烈建议）
- [ ] 审查8个MAJOR级别问题，决定是否修复
- [ ] 运行 `/speckit.codereview --fix` 自动修复部分问题（需用户确认）
```

### 6. 提供修复建议

在报告末尾询问用户：

"检测到 X 个问题。是否需要：
1. 查看某个具体问题的详细修复方案？
2. 自动生成修复建议清单？
3. 立即修复可自动修复的问题？（需要您明确授权）

请告诉我您的选择。"

## 高级选项

支持以下可选参数（从 $ARGUMENTS 解析）：

- `--scope=<path>`: 指定审查范围，默认为 src/main/java/
- `--include-tests`: 包含测试代码
- `--severity=<level>`: 只报告指定严重程度及以上的问题（BLOCKER|CRITICAL|MAJOR|MINOR|INFO）
- `--category=<type>`: 只检查指定类别（naming|format|oop|collection|concurrent|control|comment|exception|database|security）
- `--exclude=<pattern>`: 排除特定文件或目录
- `--fix`: 自动修复模式（需用户确认，仅修复安全的格式类问题）
- `--output=<format>`: 输出格式（markdown|html|json），默认markdown

## 实现原则

### Token效率优化

- **渐进式加载**: 不一次性读取所有文件，按需加载
- **智能采样**: 对于大型项目（>50个文件），先采样分析，生成初步报告
- **问题聚合**: 相同类型的问题合并展示，避免冗余
- **引用原则**: 使用文件路径+行号引用，不重复粘贴大段代码

### 分析准确性

- **上下文感知**: 理解业务逻辑上下文，避免误报
- **框架识别**: 识别Spring Boot、MyBatis等框架特性，调整检查策略
- **注解理解**: 正确理解@Transactional、@Async等注解的影响

### 用户体验

- **结果可读**: 报告清晰易懂，有具体示例
- **可操作性**: 提供明确的修复建议，不仅指出问题
- **优先级明确**: 清晰的严重程度分级和修复优先级

## 示例用法

```bash
# 审查所有代码
/speckit.codereview

# 审查特定包
/speckit.codereview --scope=com/czf/service/

# 只查看严重问题
/speckit.codereview --severity=CRITICAL

# 只检查命名和安全规范
/speckit.codereview --category=naming,security

# 包含测试代码的审查
/speckit.codereview --include-tests

# 生成JSON格式报告
/speckit.codereview --output=json
```

## 参考资料

本命令基于以下规范：
- 《阿里巴巴Java开发手册》（嵩山版）
- 阿里巴巴Java代码规约扫描插件规则
- OWASP Top 10 安全风险
- 《重构：改善既有代码的设计》
- 《代码整洁之道》

